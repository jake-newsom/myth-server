openapi: 3.0.0
info:
  title: Viking Vengeance Authentication API
  description: API for user registration and authentication with token-based session management
  version: 2.0.0

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    User:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        username:
          type: string
        email:
          type: string
        in_game_currency:
          type: integer
          description: Legacy field - use gold, gems, and fate_coins instead
        gold:
          type: integer
          description: Primary in-game currency
        gems:
          type: integer
          description: Premium currency
        fate_coins:
          type: integer
          description: Special currency for fate picks
        total_xp:
          type: integer
          description: Total experience points earned

    AuthResponse:
      type: object
      properties:
        accessToken:
          type: string
          description: Short-lived access token (15 minutes)
        refreshToken:
          type: string
          description: Long-lived refresh token (90 days)
        expiresAt:
          type: string
          format: date-time
          description: Access token expiration timestamp
        user:
          $ref: "#/components/schemas/User"

    RefreshResponse:
      type: object
      properties:
        accessToken:
          type: string
          description: New short-lived access token (15 minutes)
        refreshToken:
          type: string
          description: New long-lived refresh token (90 days)
        expiresAt:
          type: string
          format: date-time
          description: Access token expiration timestamp

    Session:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        device_type:
          type: string
        user_agent:
          type: string
        ip_address:
          type: string
        created_at:
          type: string
          format: date-time
        last_used_at:
          type: string
          format: date-time
        is_current:
          type: boolean
          description: Whether this is the current session

paths:
  /api/auth/register:
    post:
      summary: Register a new user
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - password
              properties:
                username:
                  type: string
                  maxLength: 32
                  description: Username (maximum 32 characters)
                  example: thor_hammer
                email:
                  type: string
                  format: email
                  example: thor@asgard.com
                password:
                  type: string
                  format: password
                  minLength: 6
                  description: Password (minimum 6 characters)
                  example: mjolnir123
      responses:
        201:
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        400:
          description: Bad request (validation error)
        409:
          description: User already exists with that email or username
        500:
          description: Server error

  /api/auth/login:
    post:
      summary: Log in an existing user
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: thor@asgard.com
                password:
                  type: string
                  format: password
                  example: mjolnir123
      responses:
        200:
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        400:
          description: Invalid email or password
        401:
          description: Authentication failed
        500:
          description: Server error

  /api/auth/facebook:
    post:
      summary: Authenticate with Facebook
      description: Login or register using Facebook OAuth token
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - accessToken
              properties:
                accessToken:
                  type: string
                  description: Facebook access token obtained from Facebook SDK
                  example: "EAABwzLixnjYBOZCZCZC..."
      responses:
        200:
          description: Login successful (existing user)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        201:
          description: Registration successful (new user)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        400:
          description: Facebook access token is required
        401:
          description: Invalid Facebook access token
        409:
          description: Email already exists with local account
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "An account with this email already exists. Please log in with your email and password first, then link your Facebook account in settings."
                      code:
                        type: string
                        example: "EMAIL_ALREADY_EXISTS"
        500:
          description: Server error

  /api/auth/apple:
    post:
      summary: Authenticate with Apple
      description: Login or register using Apple identity token
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - identityToken
              properties:
                identityToken:
                  type: string
                  description: Apple identity token obtained from Apple Sign In
                  example: "eyJraWQiOiJlWGF1bm1..."
                user:
                  type: object
                  description: Optional user info provided by Apple on first sign-in
                  properties:
                    name:
                      type: object
                      properties:
                        firstName:
                          type: string
                        lastName:
                          type: string
      responses:
        200:
          description: Login successful (existing user)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        201:
          description: Registration successful (new user)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        400:
          description: Apple identity token is required
        401:
          description: Invalid Apple identity token
        500:
          description: Server error

  /api/auth/google:
    post:
      summary: Authenticate with Google
      description: Login or register using Google ID token
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - idToken
              properties:
                idToken:
                  type: string
                  description: Google ID token obtained from Google Sign In
                  example: "eyJhbGciOiJSUzI1NiIs..."
      responses:
        200:
          description: Login successful (existing user)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        201:
          description: Registration successful (new user)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        400:
          description: Google ID token is required
        401:
          description: Invalid Google ID token
        500:
          description: Server error

  /api/auth/facebook/deauthorize:
    post:
      summary: Facebook deauthorization callback
      description: Handles deauthorization requests from Facebook when users remove the app
      tags:
        - Authentication
        - Compliance
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - signed_request
              properties:
                signed_request:
                  type: string
                  description: Signed request from Facebook containing user ID
      responses:
        200:
          description: Deauthorization processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    description: Confirmation URL for the user
                    example: "https://yourapp.com/account-deauthorized"

  /api/auth/facebook/data-deletion:
    post:
      summary: Facebook data deletion callback
      description: Handles data deletion requests from Facebook for GDPR compliance
      tags:
        - Authentication
        - Compliance
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - signed_request
              properties:
                signed_request:
                  type: string
                  description: Signed request from Facebook containing user ID
      responses:
        200:
          description: Data deletion request processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    description: Status URL for tracking deletion progress
                    example: "https://yourapp.com/data-deletion-status?code=DEL_123456789"
                  confirmation_code:
                    type: string
                    description: Unique code for tracking the deletion request
                    example: "DEL_1640995200000_abcd1234"

  /api/auth/facebook/link:
    post:
      summary: Link Facebook account to existing user
      description: Links a Facebook account to the currently authenticated user
      tags:
        - Authentication
        - Account Management
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - accessToken
              properties:
                accessToken:
                  type: string
                  description: Facebook access token obtained from Facebook SDK
                  example: "EAABwzLixnjYBOZCZCZC..."
      responses:
        200:
          description: Facebook account linked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Facebook account linked successfully"
                  user:
                    $ref: "#/components/schemas/User"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Facebook access token is required."
        401:
          description: Unauthorized or invalid Facebook token
        409:
          description: Conflict - Facebook account already linked
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "This Facebook account is already linked to another user."
                      code:
                        type: string
                        enum: ["FACEBOOK_ALREADY_LINKED", "FACEBOOK_ALREADY_EXISTS"]
        500:
          description: Server error

  /api/auth/facebook/unlink:
    delete:
      summary: Unlink Facebook account from user
      description: Removes the Facebook account link from the currently authenticated user
      tags:
        - Authentication
        - Account Management
      security:
        - bearerAuth: []
      responses:
        200:
          description: Facebook account unlinked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Facebook account unlinked successfully"
                  user:
                    $ref: "#/components/schemas/User"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "No Facebook account is currently linked."
                      code:
                        type: string
                        enum: ["PRIMARY_AUTH_METHOD"]
        401:
          description: Not authenticated
        500:
          description: Server error

  /api/auth/apple/link:
    post:
      summary: Link Apple account to existing user
      description: Links an Apple account to the currently authenticated user
      tags:
        - Authentication
        - Account Management
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - identityToken
              properties:
                identityToken:
                  type: string
                  description: Apple identity token obtained from Apple Sign In
                  example: "eyJraWQiOiJlWGF1bm1..."
      responses:
        200:
          description: Apple account linked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Apple account linked successfully"
                  user:
                    $ref: "#/components/schemas/User"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Apple identity token is required."
        401:
          description: Unauthorized or invalid Apple token
        409:
          description: Conflict - Apple account already linked
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "This Apple account is already linked to another user."
                      code:
                        type: string
                        enum: ["APPLE_ALREADY_LINKED", "APPLE_ALREADY_EXISTS"]
        500:
          description: Server error

  /api/auth/apple/unlink:
    delete:
      summary: Unlink Apple account from user
      description: Removes the Apple account link from the currently authenticated user
      tags:
        - Authentication
        - Account Management
      security:
        - bearerAuth: []
      responses:
        200:
          description: Apple account unlinked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Apple account unlinked successfully"
                  user:
                    $ref: "#/components/schemas/User"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "No Apple account is currently linked."
                      code:
                        type: string
                        enum: ["PRIMARY_AUTH_METHOD"]
        401:
          description: Not authenticated
        500:
          description: Server error

  /api/auth/google/link:
    post:
      summary: Link Google account to existing user
      description: Links a Google account to the currently authenticated user
      tags:
        - Authentication
        - Account Management
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - idToken
              properties:
                idToken:
                  type: string
                  description: Google ID token obtained from Google Sign In
                  example: "eyJhbGciOiJSUzI1NiIs..."
      responses:
        200:
          description: Google account linked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Google account linked successfully"
                  user:
                    $ref: "#/components/schemas/User"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Google ID token is required."
        401:
          description: Unauthorized or invalid Google token
        409:
          description: Conflict - Google account already linked
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "This Google account is already linked to another user."
                      code:
                        type: string
                        enum: ["GOOGLE_ALREADY_LINKED", "GOOGLE_ALREADY_EXISTS"]
        500:
          description: Server error

  /api/auth/google/unlink:
    delete:
      summary: Unlink Google account from user
      description: Removes the Google account link from the currently authenticated user
      tags:
        - Authentication
        - Account Management
      security:
        - bearerAuth: []
      responses:
        200:
          description: Google account unlinked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Google account unlinked successfully"
                  user:
                    $ref: "#/components/schemas/User"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "No Google account is currently linked."
                      code:
                        type: string
                        enum: ["PRIMARY_AUTH_METHOD"]
        401:
          description: Not authenticated
        500:
          description: Server error

  /api/auth/refresh:
    post:
      summary: Refresh access token using refresh token
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: Valid refresh token
      responses:
        200:
          description: Tokens refreshed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshResponse"
        400:
          description: Refresh token is required
        401:
          description: Invalid or expired refresh token
        500:
          description: Server error

  /api/auth/logout:
    post:
      summary: Logout from current session
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        200:
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully.
        401:
          description: Not authenticated
        500:
          description: Server error

  /api/auth/logout-all:
    post:
      summary: Logout from all sessions
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        200:
          description: Logged out from all devices successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out from all devices successfully.
        401:
          description: Not authenticated
        500:
          description: Server error

  /api/auth/sessions:
    get:
      summary: Get all active sessions for the current user
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        200:
          description: Sessions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: "#/components/schemas/Session"
        401:
          description: Not authenticated
        500:
          description: Server error
