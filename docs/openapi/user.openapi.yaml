openapi: 3.0.0
info:
  title: Viking Vengeance - User API
  description: API endpoints for user profiles, card collections, and decks
  version: 1.0.0

paths:
  /api/users/me:
    get:
      summary: Get current user profile
      description: Retrieve the current authenticated user's profile information
      tags:
        - Users
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Successfully retrieved user profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfile"
        "401":
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      summary: Update account details
      description: Update the current user's username, email, and/or password
      tags:
        - Users
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  maxLength: 32
                  description: New username (optional, maximum 32 characters)
                  example: new_username
                email:
                  type: string
                  format: email
                  description: New email address (optional)
                  example: newemail@example.com
                password:
                  type: string
                  format: password
                  minLength: 6
                  description: New password (optional, requires currentPassword)
                  example: newpassword123
                currentPassword:
                  type: string
                  format: password
                  description: Current password (required when updating password)
                  example: currentpassword123
            examples:
              updateUsername:
                summary: Update username only
                value:
                  username: new_username
              updateEmail:
                summary: Update email only
                value:
                  email: newemail@example.com
              updatePassword:
                summary: Update password
                value:
                  password: newpassword123
                  currentPassword: currentpassword123
              updateAll:
                summary: Update all fields
                value:
                  username: new_username
                  email: newemail@example.com
                  password: newpassword123
                  currentPassword: currentpassword123
      responses:
        "200":
          description: Account details updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Account details updated successfully.
                  user:
                    $ref: "#/components/schemas/UserProfile"
        "400":
          description: Bad request - validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                noFieldsProvided:
                  summary: No fields provided
                  value:
                    error:
                      message: At least one field (username, email, or password) must be provided for update.
                passwordTooShort:
                  summary: Password too short
                  value:
                    error:
                      message: New password must be at least 6 characters long.
                currentPasswordRequired:
                  summary: Current password required
                  value:
                    error:
                      message: Current password is required to update password.
                invalidEmail:
                  summary: Invalid email format
                  value:
                    error:
                      message: Invalid email format.
                usernameTooLong:
                  summary: Username too long
                  value:
                    error:
                      message: Username must be 32 characters or less.
        "401":
          description: Unauthorized - missing/invalid token or incorrect current password
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                notAuthenticated:
                  summary: Not authenticated
                  value:
                    error:
                      message: User not authenticated.
                incorrectPassword:
                  summary: Incorrect current password
                  value:
                    error:
                      message: Current password is incorrect.
        "409":
          description: Conflict - username or email already in use
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                      code:
                        type: string
              examples:
                usernameExists:
                  summary: Username already taken
                  value:
                    error:
                      message: Username already taken.
                      code: USERNAME_ALREADY_EXISTS
                emailExists:
                  summary: Email already in use
                  value:
                    error:
                      message: Email already in use.
                      code: EMAIL_ALREADY_EXISTS
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/users/me/cards:
    get:
      summary: Get user's card collection
      description: Retrieve all card instances owned by the current user
      tags:
        - Users
        - Cards
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Successfully retrieved user's card instances
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "./userCard.openapi.yaml#/components/schemas/UserCard"
        "401":
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/users/me/decks:
    get:
      summary: Get user's decks
      description: Retrieve all decks owned by the current user with their complete card details
      tags:
        - Users
        - Decks
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Successfully retrieved user's decks with all card details
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "./deck.openapi.yaml#/components/schemas/DeckDetailResponse"
        "401":
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/users/me/decks/{deckId}:
    get:
      summary: Get specific deck details
      description: Retrieve detailed information about a specific deck including contained cards
      tags:
        - Users
        - Decks
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: deckId
          required: true
          schema:
            type: string
          description: ID of the deck to retrieve
      responses:
        "200":
          description: Successfully retrieved deck details
          content:
            application/json:
              schema:
                $ref: "./deck.openapi.yaml#/components/schemas/DeckDetailResponse"
        "401":
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Deck not found or not owned by user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/users/me/monthly-login/status:
    get:
      summary: Get monthly login status
      description: Retrieve the current user's monthly login reward progress and available rewards
      tags:
        - Users
        - Rewards
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Successfully retrieved monthly login status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MonthlyLoginStatusResponse"
        "401":
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/users/me/monthly-login/claim:
    post:
      summary: Claim monthly login reward
      description: Claim the next available daily reward. Automatically detects which day the user is eligible to claim based on their progress and the current server date.
      tags:
        - Users
        - Rewards
      security:
        - bearerAuth: []
      requestBody:
        required: false
        description: No request body needed - endpoint automatically claims next available day
      responses:
        "200":
          description: Successfully claimed reward
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClaimMonthlyRewardResponse"
        "400":
          description: Bad request - invalid day or reward already claimed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized - missing or invalid token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT Authorization header using the Bearer scheme

  schemas:
    UserProfile:
      type: object
      properties:
        user_id:
          type: string
          description: Unique identifier for the user
        username:
          type: string
          description: User's display name
        email:
          type: string
          format: email
          description: User's email address
        in_game_currency:
          type: integer
          description: User's legacy currency amount (deprecated, use gold/gems)
        gold:
          type: integer
          description: User's current gold amount
        gems:
          type: integer
          description: User's current gems amount
        fate_coins:
          type: integer
          description: User's current fate coins amount
        total_xp:
          type: integer
          description: User's total XP accumulated
        pack_count:
          type: integer
          description: Number of packs the user currently has
        win_streak_multiplier:
          type: number
          format: float
          minimum: 1.0
          maximum: 5.0
          description: Win streak multiplier for online games (1.0 - 5.0)
        created_at:
          type: string
          format: date-time
          description: When the user account was created
        last_login_at:
          type: string
          format: date-time
          description: When the user last logged in
      required:
        - user_id
        - username
        - email
        - in_game_currency
        - gold
        - gems
        - fate_coins
        - total_xp
        - pack_count
        - win_streak_multiplier
        - created_at
        - last_login_at

    DeckSummary:
      type: object
      properties:
        deck_id:
          type: string
          description: Unique identifier for the deck
        name:
          type: string
          description: Name of the deck
        created_at:
          type: string
          format: date-time
          description: When the deck was created
        last_updated:
          type: string
          format: date-time
          description: When the deck was last updated
        card_count:
          type: integer
          description: Number of cards in the deck
      required:
        - deck_id
        - name
        - created_at
        - last_updated
        - card_count

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            message:
              type: string
              description: Error message
            statusCode:
              type: integer
              description: HTTP status code
            code:
              type: string
              description: Error code for client-side handling
          required:
            - message
      required:
        - error

    MonthlyLoginStatusResponse:
      type: object
      properties:
        month_year:
          type: string
          pattern: '^\d{4}-\d{2}$'
          description: Current month in YYYY-MM format
          example: "2024-01"
        current_day:
          type: integer
          minimum: 0
          maximum: 24
          description: Current highest day reached (0-24)
        claimed_days:
          type: array
          items:
            type: integer
            minimum: 1
            maximum: 24
          description: Array of day numbers that have been claimed
        available_days:
          type: array
          items:
            type: integer
            minimum: 1
            maximum: 24
          description: Array of days that can be claimed (up to current day)
        rewards:
          type: array
          items:
            $ref: "#/components/schemas/MonthlyRewardInfo"
          description: Array of all 24 daily rewards with claim status
      required:
        - month_year
        - current_day
        - claimed_days
        - available_days
        - rewards

    MonthlyRewardInfo:
      type: object
      properties:
        day:
          type: integer
          minimum: 1
          maximum: 24
          description: Day number (1-24)
        reward_type:
          type: string
          enum:
            - gems
            - fate_coins
            - card_fragments
            - card_pack
            - enhanced_card
          description: Type of reward for this day
        amount:
          type: integer
          description: Amount of reward (for gems, fragments, coins, packs)
        is_claimed:
          type: boolean
          description: Whether this day's reward has been claimed
        can_claim:
          type: boolean
          description: Whether this day's reward can be claimed now
      required:
        - day
        - reward_type
        - amount
        - is_claimed
        - can_claim

    ClaimMonthlyRewardResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether the claim was successful
        message:
          type: string
          description: Success message
        reward:
          type: object
          properties:
            day:
              type: integer
              minimum: 1
              maximum: 24
            reward_type:
              type: string
              enum:
                - gems
                - fate_coins
                - card_fragments
                - card_pack
                - enhanced_card
            amount:
              type: integer
            card_id:
              type: string
              description: Card ID for enhanced_card rewards (optional)
          required:
            - day
            - reward_type
            - amount
        updated_progress:
          type: object
          properties:
            current_day:
              type: integer
              minimum: 0
              maximum: 24
            claimed_days:
              type: array
              items:
                type: integer
          required:
            - current_day
            - claimed_days
      required:
        - success
        - message
        - reward
        - updated_progress
